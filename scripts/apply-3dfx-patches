#!/bin/bash
set -e  # Exit on any error

# Check if source directory is provided
if [ -z "$1" ]; then
  echo "Error: Please specify the QEMU source directory"
  echo "Usage: apply-3dfx-patches /path/to/qemu-src"
  exit 1
fi

QEMU_SRC="$1"

if [ ! -d "$QEMU_SRC" ]; then
  echo "Error: QEMU source directory not found: $QEMU_SRC"
  exit 1
fi

# Check if SDL2 is recent enough to already have virgl patches
SDL_VERSION=$(sdl2-config --version)
SDL_MAJOR=$(echo $SDL_VERSION | cut -d. -f1)
SDL_MINOR=$(echo $SDL_VERSION | cut -d. -f2)

# SDL 2.28.0 or newer might have the virgl patches incorporated
if [ "$SDL_MAJOR" -gt 2 ] || ([ "$SDL_MAJOR" == 2 ] && [ "$SDL_MINOR" -ge 28 ]); then
  echo "Note: Your SDL2 version ($SDL_VERSION) might already include virgl patches."
  echo "Some of the patches might not be necessary or could conflict."
  read -p "Do you want to continue applying the patches? (y/n) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Patch application aborted."
    exit 1
  fi
fi

# Define the patch directory
PATCH_DIR="$(brew --prefix)/opt/qemu-virgl-deps/patches"

# Verify that the patch directory exists
if [ ! -d "$PATCH_DIR" ]; then
  echo "Error: Patch directory not found: $PATCH_DIR"
  exit 1
fi

# Apply the virgl patches
echo "Applying virgl patches from $PATCH_DIR..."

# Main EGL optional patch
if [ -f "$PATCH_DIR/egl-optional.patch" ]; then
  echo "Applying EGL optional patch..."
  patch -p1 -d "$QEMU_SRC" < "$PATCH_DIR/egl-optional.patch" || {
    echo "Warning: EGL optional patch failed, it may already be applied."
  }
fi

# Apply Virgil3D with SDL2 OpenGL patch
if [ -f "$PATCH_DIR/0001-Virgil3D-with-SDL2-OpenGL.patch" ]; then
  echo "Applying Virgil3D with SDL2 OpenGL patch..."
  patch -p1 -d "$QEMU_SRC" < "$PATCH_DIR/0001-Virgil3D-with-SDL2-OpenGL.patch" || {
    echo "Warning: SDL2 OpenGL patch failed, it may already be applied."
  }
fi

echo "Patches applied. Now you can build QEMU with: compile-qemu-virgl $QEMU_SRC"
