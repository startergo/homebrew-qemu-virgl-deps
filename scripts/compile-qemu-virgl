#!/bin/bash

# Check if source directory is provided
if [ -z "$1" ]; then
  echo "Error: Please specify the QEMU source directory"
  echo "Usage: compile-qemu-virgl /path/to/qemu-src [additional configure options]"
  exit 1
fi

QEMU_SRC="$1"
shift

if [ ! -d "$QEMU_SRC" ]; then
  echo "Error: QEMU source directory not found: $QEMU_SRC"
  exit 1
fi

# Get SDK path for framework headers
SDK_PATH=$(xcrun --show-sdk-path)

# Get Homebrew prefix dynamically
BREW_PREFIX=$(brew --prefix)
export PKG_CONFIG_PATH="$BREW_PREFIX/opt/qemu-virgl-deps/lib/qemu-virgl/pkgconfig:$PKG_CONFIG_PATH"
export CFLAGS="-F$SDK_PATH/System/Library/Frameworks -I$BREW_PREFIX/opt/qemu-virgl-deps/include/qemu-virgl/epoxy -I$BREW_PREFIX/opt/qemu-virgl-deps/include/qemu-virgl/virgl OPENGL_CORE_FLAG -I$BREW_PREFIX/opt/qemu-virgl-deps/include/qemu-virgl/angle $CFLAGS"
export LDFLAGS="-F$SDK_PATH/System/Library/Frameworks -L$BREW_PREFIX/opt/qemu-virgl-deps/lib/qemu-virgl $LDFLAGS"
export OBJCFLAGS="-F$SDK_PATH/System/Library/Frameworks $OBJCFLAGS"

echo "Configuring QEMU with Virgl support..."
echo "Using SDK path: $SDK_PATH"

# If OpenGL core build is enabled, apply the EGL patch
if [ "$BUILD_OPENGL_CORE" == "1" ]; then
  echo "OpenGL core build enabled. Applying EGL patch..."
  # Change to the directory where this script is located, then use an absolute path.
  SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
  PATCH_SCRIPT="$SCRIPT_DIR/scripts/apply-egl-patch.sh"
  if [ ! -f "$PATCH_SCRIPT" ]; then
    echo "Error: Patch script not found at $PATCH_SCRIPT"
    exit 1
  fi
  if [ ! -x "$PATCH_SCRIPT" ]; then
    echo "Setting execute permission on $PATCH_SCRIPT"
    chmod +x "$PATCH_SCRIPT"
  fi
  "$PATCH_SCRIPT"
fi

# Change directory to the QEMU source and run configure with required options for Virgl
cd "$QEMU_SRC"

./configure --target-list=i386-softmmu,x86_64-softmmu,aarch64-softmmu --enable-opengl --enable-virglrenderer --enable-sdl "$@"

if [ $? -ne 0 ]; then
  echo "Configuration failed. Please check error messages above."
  exit 1
fi

echo ""
echo "Configuration successful! To build QEMU, run:"
echo "cd $QEMU_SRC && make -j$(sysctl -n hw.ncpu)"
echo ""

if [ "$BUILD_OPENGL_CORE" == "1" ]; then
  echo "After building, you can run QEMU with OpenGL Core backend (kjliew's approach):"
  echo "qemu-system-x86_64 -display sdl,gl=core [other options]"
  echo ""
  echo "----------------------------------------------"
  echo "IMPORTANT: You are building with the OpenGL Core backend."
  echo "Before you build QEMU further, please run the EGL patch:"
  echo "  apply-egl-patch"
  echo "This will patch the egl-helpers.h file for proper OpenGL Core support."
  echo "----------------------------------------------"
else
  echo "After building, you can run QEMU with different GL backends:"
  echo "  gl=off  - Disable Virgil 3D GPU. Most stable but laggy."
  echo "  gl=core - Enable OpenGL.framework. May be unstable."
  echo "  gl=es   - Enable ANGLE. Stable and fast. (Recommended)"
fi