 #!/bin/bash
  set -e

  # Script to compile QEMU with virgl support
  QEMU_SRC="$1"
  if [ -z "$QEMU_SRC" ]; then
    echo "Usage: $0 <path-to-qemu-source>"
    exit 1
  fi

  cd "$QEMU_SRC"
  
  # Apply patches first if using OpenGL Core
  if [ "#{build.with?("opengl-core") ? "true" : "false"}" = "true" ]; then
    echo "===== Adding OpenGL Core option to QEMU meson build ====="
    #{opt_bin}/add-opengl-core-option "$QEMU_SRC"
    
    echo "===== Applying EGL headers patch for OpenGL Core ====="
    #{opt_bin}/apply-headers-patch "$QEMU_SRC"
    
    # Verify the option was added
    if grep -q "option('opengl_core'" meson_options.txt; then
      echo "âœ“ Successfully added OpenGL Core option"
      OPENGL_FLAGS="--meson-option=opengl_core=true"
    else
      echo "ERROR: Failed to add OpenGL Core option to meson_options.txt"
      exit 1
    fi
  else
    OPENGL_FLAGS=""
  fi

  mkdir -p build
  cd build
  
  # Set up environment
  export PKG_CONFIG_PATH="#{opt_lib}/qemu-virgl/pkgconfig:$PKG_CONFIG_PATH"
  
  # Configure with appropriate options
  echo "===== Configuring QEMU ====="
  ../configure --prefix=/usr/local \\
    --enable-opengl \\
    --enable-virglrenderer \\
    --extra-cflags="-I#{opt_include}/qemu-virgl" \\
    --extra-ldflags="-L#{opt_lib}/qemu-virgl" \\
    $OPENGL_FLAGS

  echo "===== QEMU configured successfully ====="
  echo "Now run: cd build && make -j$(sysctl -n hw.ncpu)"
