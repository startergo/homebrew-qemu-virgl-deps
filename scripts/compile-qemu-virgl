 #!/bin/bash
  set -e

  # Script to compile QEMU with virgl support
  QEMU_SRC="$1"
  if [ -z "$QEMU_SRC" ]; then
    echo "Usage: $0 <path-to-qemu-source>"
    exit 1
  fi

  cd "$QEMU_SRC"
  
  # Apply patches if needed for OpenGL Core
  if [ "#{build.with?("opengl-core") ? "true" : "false"}" = "true" ]; then
    echo "Adding OpenGL Core option to QEMU..."
    add-opengl-core-option "$QEMU_SRC"
    
    echo "Applying EGL optional headers patch..."
    apply-headers-patch "$QEMU_SRC"
  fi

  mkdir -p build
  cd build

  # Set up environment
  export PKG_CONFIG_PATH="#{opt_lib}/qemu-virgl/pkgconfig:$PKG_CONFIG_PATH"
  
  # Determine configure flags based on build type
  if [ "#{build.with?("opengl-core") ? "true" : "false"}" = "true" ]; then
    echo "Configuring QEMU with OpenGL Core support..."
    configure_flags="--meson-option=opengl_core=true"
  else
    configure_flags=""
  fi
  
  # Configure with appropriate options
  ../configure --prefix=/usr/local \\
    --enable-opengl \\
    --enable-virglrenderer \\
    --extra-cflags="-I#{opt_include}/qemu-virgl" \\
    --extra-ldflags="-L#{opt_lib}/qemu-virgl" \\
    $configure_flags

  echo "QEMU configured successfully. Now run 'make -j$(sysctl -n hw.ncpu)' to build."